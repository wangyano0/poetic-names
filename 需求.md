## 古诗文起名产品需求文档（PRD）

### 1. 产品愿景
- **目标**: 基于《诗经》《楚辞》《唐诗》《宋词》等经典文献，为新生儿生成具有诗意与文化内涵的名字，并以“故事化卡片”的形式呈现：展示出处、原文、英文翻译、寓意解读，并可配中国风插画，提高吸引力与可传播性。
- **定位**: 面向新手父母、国风爱好者与内容创作者的取名工具与灵感库。

### 2. 范围与非目标
- **In Scope**
  - 关键词/风格（诗经/楚辞/唐/宋）检索与候选名生成
  - 脏字不宜用字过滤
  - 名字卡片化展示（出处/原文/翻译/寓意/插画）
  - SEO 友好的详情页与分享卡片
- **Out of Scope（首版不做）**
  - 八字/命理深度定制
  - 用户登录、收藏夹、复杂社交功能
  - 复杂电商付费系统

### 3. 数据与内容来源
- 已有数据目录: `json/`（`shijing.json`、`chuci.json`、`tangshi.json`、`songci.json`、`cifu.json`、`yuefu.json`、`gushi.json`、`test.json`）
- 数据清洗: 生成 `json_sanitized/` 作为检索与生成的可靠来源。
- 黑名单词表（可持续扩展）: `胸, 鬼, 懒, 禽, 鸟, 鸡, 我, 邪, 罪, 凶, 丑, 仇, 鼠, 蟋蟀, 淫秽, 妹, 狐, 鸭, 蝇, 悔, 鱼, 肉, 苦, 犬, 吠, 窥, 血, 丧, 饥, 女, 搔, 父母, 昏, 狗, 蟊, 疾病, 痛, 死, 潦, 哀, 痒, 害, 蛇, 牲, 妇, 狸, 鹅, 穴, 畜, 烂, 兽, 靡, 爪, 氓, 劫, 鬣, 螽, 毛, 婚姻, 匪, 婆, 羞辱`。

### 4. 技术方案（推荐）
- **整体**: Next.js（App Router）+ TypeScript + SQLite（FTS5 全文检索）+ `nodejieba` 中文分词
  - SSR/ISR 兼顾 SEO，API Route 方便前后端一体开发
  - SQLite 单文件部署，FTS5 支持中文检索（结合分词）
  - 可平滑升级向量检索与 Embedding（如后续需要语义召回）

### 5. 系统模块
- **数据导入与清洗**
  - 读取 `json/`，按统一 schema 规范化（题目、作者、朝代、体裁、正文、来源合集）
  - 递归检测任意字段是否包含黑名单；命中则丢弃该记录或字段
  - 输出 `json_sanitized/`，并导入 SQLite，建立 FTS5 索引

- **检索与候选名生成**
  - 输入：关键词（寓意/特质）、偏好来源（诗经/楚辞/唐/宋/不限）、性别倾向（可选）、字数（单/双字）
  - 分词：使用 `nodejieba` 对用户输入与诗文正文进行分词、关键词抽取
  - 召回：FTS5 根据关键词、作者/体裁/朝代过滤
  - 生成：从命中的诗句抽取可用字词，结合避讳与用字规则做组合与评分（音律、寓意、频次、现代语感）
  - 二次过滤：对候选名再次应用黑名单与不良搭配规则

- **故事化卡片渲染**
  - 每个名字对应一张“名字故事卡”：
    - 名字（中/英转写）
    - 出处（作品名、作者、体裁、朝代）
    - 原文片段（含命中句）
    - 英文翻译（直译+意译，优先可读性）
    - 寓意解读（2-4 句，结合出处意象进行现代化阐释）
    - 相关插画（国风风格，可用 Prompt 生成/手绘资源）
    - 评分（0-100，综合音义形）

- **SEO 与分享**
  - 生成静态/半静态详情路径（如 `/name/若溪`）
  - Open Graph/Twitter Card，导出分享图（含插画与摘要）
  - 站内检索页与专题页（如“诗经风格女孩名”）

### 6. 数据库与索引设计（SQLite）
```sql
-- 表：works（诗文）
CREATE TABLE IF NOT EXISTS works (
  id INTEGER PRIMARY KEY,
  title TEXT,
  author TEXT,
  dynasty TEXT,
  genre TEXT,
  source TEXT,  -- shijing/chuci/tangshi/songci/...
  content TEXT
);

-- FTS5 索引：title, author, content
CREATE VIRTUAL TABLE IF NOT EXISTS works_fts USING fts5(
  title, author, content, content='works', content_rowid='id'
);

-- 触发器保持 FTS 同步（可选首版批量导入后一次性重建）
```

### 7. API 设计（初版）
- `POST /api/search`
  - 入参：`{ query: string, sources?: string[], size?: number }`
  - 出参：诗文命中结果，用于后续生成

- `POST /api/generate`
  - 入参：`{ query: string, sources?: string[], gender?: 'boy'|'girl'|'any', charCount?: 1|2 }`
  - 出参：`NameCard[]`（见下方 schema），内部会调用分词、召回、组合、评分与过滤

- `GET /api/name/[name]`
  - 入参：path param
  - 出参：单个 `NameCard` 详情（用于 SEO 页面）

### 8. 前端交互与 UI 规范
- **首页**：
  - 搜索框（提示语：输入寓意/关键词，如“清雅/坚韧/山海/松风”）
  - 来源与风格选择（复选）：诗经、楚辞、唐诗、宋词、不限
  - 字数与性别倾向选项
  - 生成按钮 → 跳转结果页

- **结果页**（卡片瀑布流 / 3 列响应式）
  - 名字故事卡：
    - 标题：名字 + 评分
    - 标签：来源、作者、朝代
    - 原文：高亮命中片段
    - 翻译：英文意译为主，辅以直译短句
    - 寓意：2-4 句，口语友好
    - 插画：国风，偏水墨/留白；移动端屏宽自适应
    - 操作：复制名称、查看详情、下载分享图

- **详情页**：
  - 更完整的出处与延伸阅读（同作其他名句）
  - 社交分享（OG 图）

### 9. 名字卡片数据结构
```ts
type NameCard = {
  name: string;               // 名字（中文）
  pinyin?: string;            // 可选，拼音
  score: number;              // 0-100
  source: {
    workId: number;
    title: string;
    author?: string;
    dynasty?: string;
    genre?: string;
    sourceSet: string;        // shijing/chuci/tangshi/songci/...
  };
  excerpt: string;            // 命中原文片段
  translation: string;        // 英文翻译（意译优先）
  meaning: string;            // 寓意解读（2-4 句）
  illustration?: {
    prompt: string;           // 生成提示词（中文 + 英文）
    url?: string;             // 渲染后链接
  };
  createdAt: string;          // ISO 时间
};
```

### 10. 故事化呈现样例（示意）
```json
{
  "name": "若溪",
  "score": 92,
  "source": {"title": "蒹葭", "author": "佚名", "dynasty": "先秦", "genre": "诗经", "sourceSet": "shijing"},
  "excerpt": "蒹葭苍苍，白露为霜。所谓伊人，在水一方。",
  "translation": "Reeds grow lush; white dew turns to frost. The one I long for stands across the river.",
  "meaning": "取“若溪”，如溪水清澈灵动，寓清雅澄澈之质；以水意象寄托温柔与坚韧。",
  "illustration": {"prompt": "水墨国风、清晨薄雾、溪流粼粼、极简留白 | Chinese ink painting, morning mist, sparkling creek"}
}
```

### 11. 内容安全与过滤
- 离线清洗：导入前按黑名单过滤，输出 `json_sanitized/`
- 在线拦截：生成候选名后再次用同一黑名单正则过滤
- 可配置：黑名单放置 `config/blacklist.json`，支持热更新

### 12. 性能与体验
- 首屏 SSR + 结果页 ISR（例如 1 小时再验证）
- 分页/无限滚动加载，骨架屏与延迟加载插画
- 插画生成异步回填，先占位渐进增强

### 13. 项目初始化与脚手架
```bash
npx create-next-app@latest guchi-name --typescript --app --tailwind --eslint
cd guchi-name
npm i better-sqlite3 nodejieba
```

### 14. 验收标准（MVP）
- 可从首页输入关键词生成≥20个合格候选名，均通过黑名单过滤
- 每个候选名均展示：出处（含作品/作者/朝代）、原文片段、英文翻译、寓意解读
- 至少 1 张卡片带有生成的中国风插画（或占位 + 可点击生成）
- 提供任意一个名字的可分享详情页（含 OG 图元信息）

### 15. 里程碑
- M0（数据层）: 完成清洗脚本与 SQLite 导入，FTS 可检索
- M1（服务层）: /api/search 与 /api/generate 可用，含在线过滤
- M2（前端）: 结果页卡片化展示与分享图元信息
- M3（插画）: 插画生成/接入与异步回填

### 16. 风险与对策
- 中文检索召回偏弱 → 加权分词/同义词词库/后续接入向量检索
- 翻译质量参差 → 优先意译模板 + 可人工校对缓存
- 黑名单过严/过松 → 域内反馈收集，A/B 微调词表

### 17. 国际化与多语言支持（新增需求）

#### 17.1 用户群体分析
- **华人用户**：主要看中文，需要完整的中文体验
- **外国用户**：主要看英文，需要清晰的英文界面
- **双语用户**：希望中英文对照，便于理解

#### 17.2 UI设计原则
- **中英文并行展示**：保持统一排版风格，避免杂乱
- **统一对照格式**：全站采用"中文 / English"的对照形式
- **语言切换功能**：提供CN/EN切换按钮，支持三种显示模式：
  - 只中文
  - 只英文  
  - 双语对照

#### 17.3 具体实现要求

##### 17.3.1 页面标题与导航
- 搜索结果页面应展现清晰的标题与导航
- 保持"个性化寻名结果 / Personalized Name Results"的对照格式
- 所有页面元素都采用中英文对照

##### 17.3.2 名字展示优化
- **保留拼音**：对外国人友好，如"王参差 / Wáng cēn cī"
- **释义并列展示**：
  ```
  寓意美好，体现中华文化底蕴
  Beautiful meaning, reflecting Chinese cultural heritage
  ```
- **出处英文标签**：
  ```
  《关雎》· 佚名 / "Guan Ju" · Anonymous
  来源：诗经 / Source: Classic of Poetry
  ```

##### 17.3.3 按钮与操作
- **查看详情** → "查看详情 / View Details"
- **筛选和排序**：
  ```
  筛选 / Filter: 全部字数 / All Lengths
  排序 / Sort: 按拼音 / By Pinyin
  ```

### 18. 寓意生成系统优化（新增需求）

#### 18.1 当前问题
- 固定寓意模板导致重复、机械感
- 需要程序化生成多样化的寓意句子

#### 18.2 智能寓意生成方案

##### 18.2.1 名字拆解规则
- 忽略姓氏，专注于名字部分
- 分析名字中每个字的含义
- 建立字义词库，如：
  ```json
  {
    "参": ["多才多艺", "包容万物", "高远志向"],
    "差": ["和谐有序", "包容差异", "美好风景"]
  }
  ```

##### 18.2.2 句子模板系统
- 准备多样化模板，随机选用：
  - "名字寓意{含义1}，象征{含义2}。"
  - "取意{含义1}，寄托{含义2}之志。"
  - "体现{含义1}，彰显{含义2}。"
  - "蕴含{含义1}，寓意{含义2}，承载美好祝愿。"

##### 18.2.3 英文模板对应
- "The name symbolizes {meaning1}, representing {meaning2}."
- "It conveys {meaning1} and embodies {meaning2}."

#### 18.3 生成示例
- **名字**：王参差
- **含义**：参 → "多才多艺"，差 → "和谐有序"
- **生成结果**：
  - "名字寓意多才多艺，象征和谐有序。"
  - "The name symbolizes versatility, representing harmony and order."

### 19. 搜索逻辑与数据源优化（新增需求）

#### 19.1 当前问题
- 用户选择唐诗/宋词/楚辞，但生成结果总是来自同一出处
- 缺乏真正的数据源分类和过滤机制

#### 19.2 解决方案

##### 19.2.1 数据源分类存储
- 将数据源分成三大类，每类单独存储
- 唐诗、宋词、楚辞必须分开的池子
- 按用户选择严格过滤数据源

##### 19.2.2 按用户选择过滤
- 选择"唐诗"：只在唐诗池子里抽取句子
- 选择"宋词"：只在宋词池子里抽取句子  
- 选择"楚辞"：只在楚辞池子里抽取句子
- 禁止跨库抽取，确保用户体验真实

##### 19.2.3 名字抽取规则优化
- **抽取两个汉字**：从诗句里提取有意义的字
- **过滤虚词**：去掉"的、了、之"等无意义字符
- **保证组合合理**：优先在一句诗里取相邻的两个字
- **黑名单过滤**：应用敏感字表，确保结果优雅

##### 19.2.4 自动生成寓意与引用
- **示例流程**：
  1. 用户选择唐诗
  2. 来源：李白《静夜思》
  3. 诗句："床前明月光"
  4. 抽取名字："明月"
  5. 自动生成：
     - 名字：王明月
     - 寓意："取自李白《静夜思》，寓意光明纯洁，寄托美好祝愿。"

#### 19.3 关键实现要点
- **分类存储**：唐诗/宋词/楚辞必须是分开的池子
- **严格过滤**：不允许跨库抽取
- **随机选择**：避免总用第一句，增加多样性
- **黑名单过滤**：保证结果优雅和文化适宜性

### 20. 技术实现优先级
1. **高优先级**：国际化界面、语言切换功能
2. **中优先级**：寓意生成系统优化
3. **高优先级**：搜索逻辑与数据源分类优化

### 21. 验收标准更新
- 支持中英文双语界面，语言切换功能正常
- 寓意生成多样化，避免重复模板
- 数据源选择真实有效，严格按用户选择过滤
- 生成结果来源分布合理，体现选择的有效性


